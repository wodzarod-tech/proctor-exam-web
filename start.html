<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<title>Exam Title</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 16px;
      background: #f7f9fb;
      align-items: center;
      justify-content: center;
      height: 100vh;
      color:#111;
    }
    header { 
      display:flex;
      align-items:center;
      justify-content:space-between;
      position: relative;
      top: -30px;
    }
    #timer {
      white-space: nowrap; /* ensures the text stays in one line */
      width: auto;         /* automatically adjusts to content */
      font-size: 15px;
      color: #b22222;
      font-weight:700;
      /*margin-right: 35px;*/
    }
    #layout { 
      display:grid; 
      margin-top:100px; 
    }
    .panel { 
      background:white; 
      padding:12px; 
      border-radius:8px; 
      box-shadow:0 1px 6px rgba(0,0,0,0.08) 
    }
    video { 
      width: 100%; 
      border-radius:6px; 
      background: #000 
    }
    #exam .question { 
      margin-bottom:12px; 
    }
    label { 
      cursor:pointer 
    }
    button { 
      padding:8px 12px; 
      border-radius:6px; 
      border:0; 
      background:#1e6fff; 
      color:white; 
      cursor:pointer 
    }
    button.secondary { 
      background:#444; 
      margin-left:8px 
    }
    #snapshots img { 
      max-width:100%; 
      display:block; 
      margin-bottom:8px; 
      border-radius:6px; 
    }
    small { 
      color:#666 
    }
	.correct { 
    color: green; 
    font-weight:bold 
  }
  .wrong { 
    color: red; 
    font-weight:bold 
  }
	#webcam {
	  position: fixed;
	  top: 60px;
	  right: 10px;
	  border: 2px solid #333;
	  width: 150px;
	  height: 100px;
	  overflow: hidden;
	}
	#camera {
	  width: 100%;
	  height: 100%;
	  object-fit: cover;
  }
	.question pre {
	  background: #f5f5f5;
	  border: 1px solid #ddd;
	  padding: 4px 8px;
	  margin: 2px 0;
	  border-radius: 4px;
	  display: inline-block;
	  white-space: pre-wrap; /* keep line breaks and wrap long lines */
	  font-family: monospace;
	  font-size: 14px;
	}
  .button-row {
    display: none;
    justify-content: space-between; /* pushes buttons to opposite sides */
    width: 100%;
    margin-top: 12px;
  }
  #prevBtn, #nextBtn {
    padding: 10px 20px;
  }
  #prevBtn:hover {
    opacity: 0.7;
  }
  #nextBtn:hover {
    opacity: 0.7;
  }
  .button-group {
    display: none; /* required for margin:auto centering */
    margin: 40px auto 0;
    background: linear-gradient(90deg, #6aa3ff, #1ea3ff, #0fa0ff);
    border-radius: 12px;
    padding: 10px 40px;
    color: white;
    font-weight: bold;
    text-align: center;
    cursor: pointer;
    transition: opacity 0.3s ease;
    font-size: 16px;
  }
  .button-group:hover {
    opacity: 0.6;
  }
  #toggleOneAtTime {
    font-weight: bold;
    background: #8791a1;
    color: white;
    border: none;
    position: absolute;
    top: 160px;  /* moves it near top of layout */
    width: 30px;
    height: 30px;
    border-radius: 6px;
    cursor: pointer;
    align-items: center;
    justify-content: center;
    font-size: 8px;
    transition: opacity 0.3s ease;
  }
  #toggleOneAtTime:hover {
    opacity: 0.8;
  }
  #toggleOneAtTime i {
    margin-right: 6px;
  }
  </style>
</head>
<body>
  <header>
    <h1>Proctored Exam</h1>
    <div id="timer">Time Left: --:--</div>
  </header>

  <div style="margin-top:8px">
    <button id="toggleOneAtTime" style="display:none">
      <i class="fa-solid fa-chevron-down"></i>
    </button>
  </div>

  <!-- Webcam -->
  <div id="webcam">
    <video id="preview" autoplay muted playsinline></video>
  </div>
  
  <div id="layout">
    <div id="content" class="panel" class="center-box">
      <div id="exam"></div>

      <div class="button-row">
        <button id="prevBtn" class="secondary">Previous</button>
        <button id="nextBtn" class="secondary">Next</button>
      </div>

      <button id="submitBtn" class="button-group">Submit</button>
      <button id="homeBtn" class="button-group" onclick="window.location.href='index.html'">Go Home</button>

      <div id="result" style="margin-top:12px"></div>
    </div>
  </div>

<script>
/* -------------------------
   Exam parsing & rendering
   ------------------------- */
let answers = [];        // expected answers, in order
let timeLeft = 60 * 60;   // default: 15 minutes, change before start
let timerInterval = null;
let recordingActive = false;
let oneAtTime = true;
let currentIndex = 0;

document.getElementById('toggleOneAtTime').addEventListener('click', toggleOneAtTime);
document.getElementById('prevBtn').addEventListener('click', () => showQuestion(currentIndex-1));
document.getElementById('nextBtn').addEventListener('click', () => showQuestion(currentIndex+1));
document.getElementById('submitBtn').addEventListener('click', submitExam);

window.onload = function() {

  // ask for webcam and start preview + recording automatically
  initCameraAndPrepareRecording().then(() => {
    // Load questions
    const saved = localStorage.getItem("saveContent");
    if (saved) {
      parseQuestions(saved);
    }
    
    // show navigation buttons after questions are loaded
    document.getElementById("toggleOneAtTime").style.display = "inline-block";
    document.querySelector('.button-row').style.display = 'flex'; // show
    document.getElementById('submitBtn').style.display = 'block'; // show
    document.getElementById('homeBtn').style.display = 'block'; // show

    startTimer();
  }).catch(err => {
	  alert('Camera error or permission denied: ' + err);
  });
};

function parseQuestions(text){
  // split by blocks that start with '*' (like your sample)  
  const blocks = text
  .split(/\n\s*\*/g)  // split only when * starts a new block
  .map(b => b.replace(/^\s*\*/, "").trim())  // remove leading *
  .filter(Boolean);
  
  answers = [];
  const examDiv = document.getElementById('exam');
  examDiv.innerHTML = '';
  blocks.forEach((block, idx) => {
    // split off "answer =" if present
    const parts = block.split(/answer\s*=\s*/i);
    const qPart = parts[0].trim();
	const ans = parts[1]
      ? parts[1].trim().split(",").map(a => a.trim().toLowerCase())
      : [];
    answers.push(ans);

    const container = document.createElement('div');
    container.className = 'question';
    container.id = 'q' + idx;

    // first non-empty line is question title
    const lines = qPart.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const title = lines.shift() || `Question ${idx+1}`;
    const h = document.createElement('h3');
    h.textContent = `${idx+1}: ${title}`;
    container.appendChild(h);

	const correctAns = answers[idx];  // array of correct answers
	const inputType = correctAns.length > 1 ? "checkbox" : "radio";

	lines.forEach((line, i) => {
      // options usually like "a. text"
      const optMatch = line.match(/^([a-z])\.\s*(.*)$/);
      if(optMatch){
        const opt = optMatch[1].toLowerCase();
		
		// collect multi-line continuation
		let optText = optMatch[2];
		let j = i + 1;
		while (j < lines.length && /^\s/.test(lines[j])) {
		  optText += "\n" + lines[j];
		  j++;
		}
		i = j - 1; // skip collected lines
	
		// escape before inserting
		const safeText = escapeHtml(optText);
  
        const label = document.createElement('label');
        label.innerHTML = `<input type="${inputType}" name="q${idx}" value="${opt}"> ${optMatch[1]}. ${safeText}`;
		container.appendChild(label);
        container.appendChild(document.createElement('br'));
      } else {
        // non-option lines (extra) - show as text
        const p = document.createElement('p');
        p.textContent = line;
        container.appendChild(p);
      }
    });

    examDiv.appendChild(container);
  });

  // if oneAtTime default off, show all; otherwise show only first
  if(oneAtTime) showQuestion(0);
}

document.querySelectorAll('#exam input').forEach(inp => {
	  inp.disabled = false;   // make sure it’s enabled
	  inp.checked = false;    // uncheck it
	});

function handleFile(ev){
  const f = ev.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = e => {
    parseQuestions(e.target.result);
  }
  r.readAsText(f);
}

function escapeHtml(str) {
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function startTimer(){
  // you can set timeLeft before startingExam if desired
  updateTimerDisplay();
  timerInterval = setInterval(() => {
    timeLeft--;
    updateTimerDisplay();
    if(timeLeft <= 0){
      clearInterval(timerInterval);
      submitExam();
    }
  }, 1000);
}

function updateTimerDisplay(){
  const minutes = Math.max(0, Math.floor(timeLeft / 60));
  const seconds = Math.max(0, timeLeft % 60);
  document.getElementById('timer').textContent = `Time Left: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
}

/* -------------------------
   Grading / Submit
   ------------------------- */
function submitExam(){
  // stop timer
  if(timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  
  // stop recording
  if(recordingActive) toggleRecording(); // stops recorder and creates file
  
  // grade
  let score = 0, answered = 0;
  let reportScore = '<hr class="results-separator"><h2>Exam Results:</h2>';
  let reportHtml = "";


  answers.forEach((ans, i) => { 
	const selected = Array.from(document.querySelectorAll(`input[name="q${i}"]:checked`))
						  .map(x => x.value);
	
	if (selected.length > 0) {
	  answered++;

	  // sort both for easy comparison
	  const correct = [...answers[i]].sort().join(",");
	  const chosen = [...selected].sort().join(",");

	  if (correct === chosen) {
		score++;
		reportHtml += `<p>${i+1}: <span class="correct">Correct</span></p>`;
	  } else {
		reportHtml += `<p>${i+1}: <span class="wrong">Wrong</span> — Your answers: ${selected.join(",")} , Correct: ${answers[i].join(",")}</p>`;
	  }
	} else {
	  reportHtml += `<p>${i+1}: <span class="wrong">Not Answered</span> — Correct: ${answers[i].join(",")}</p>`;
	}
  });
  
  const percent = ((score / answers.length) * 100).toFixed(1);
  const status = percent >= 70 ? "✅ PASSED" : "❌ NOT PASSED";
  reportScore += `<p><strong>Score: ${score}/${answers.length} (${percent}%) → <b>${status}</b></strong></p>`;
  
  document.getElementById("result").innerHTML = reportScore + reportHtml;
  // disable inputs
  document.querySelectorAll('#exam input').forEach(inp => inp.disabled = true);
  document.getElementById('submitBtn').disabled = true;
  // keep preview running (video saved) or stop stream if you prefer
}

/* -------------------------
   One question at a time
   ------------------------- */
function toggleOneAtTime(){
  oneAtTime = !oneAtTime;
  const btn = document.getElementById('toggleOneAtTime');
  const icon = btn.querySelector('i');

  if(oneAtTime) {
    btn.innerHTML = '<i class="fa-solid fa-chevron-down"></i>';
    showQuestion(0);
  }
  else {
    // reveal all
    btn.innerHTML = '<i class="fa-solid fa-chevron-up"></i>';
    document.querySelectorAll('#exam .question').forEach(q=> q.style.display = '');
  }
}

function showQuestion(index){
  const qs = document.querySelectorAll('#exam .question');
  if(index < 0) index = 0;
  if(index >= qs.length) index = qs.length - 1;
  currentIndex = index;
  qs.forEach((q,i) => q.style.display = (i===index ? '' : 'none'));
}

/* -------------------------
   Camera + MediaRecorder
   ------------------------- */
let mediaStream = null;
let mediaRecorder = null;
let recordedChunks = [];
let snapshotTimer = null;

const preview = document.getElementById('preview');
const toggleRecordingBtn = document.getElementById('toggleRecording');
const downloadRecordingBtn = document.getElementById('downloadRecording');

async function initCameraAndPrepareRecording(){
  if(mediaStream) return; // already started
  // get camera (and optionally audio)
  mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  preview.srcObject = mediaStream;
  // prepare MediaRecorder but don't start until toggleRecording
  const options = { mimeType: 'video/webm;codecs=vp8,opus' };
  try {
    mediaRecorder = new MediaRecorder(mediaStream, options);
  } catch(e) {
    mediaRecorder = new MediaRecorder(mediaStream); // fallback
  }
  mediaRecorder.ondataavailable = e => {
    if(e.data && e.data.size > 0) recordedChunks.push(e.data);
  };
  mediaRecorder.onstop = () => {
    createRecordingBlob();
  };
}

function createRecordingBlob(){
  const blob = new Blob(recordedChunks, { type: 'video/webm' });
  const url = URL.createObjectURL(blob);
  // enable download button and set href via link
  downloadRecordingBtn.disabled = false;
  downloadRecordingBtn.onclick = () => {
    const a = document.createElement('a');
    a.href = url;
    a.download = `exam_recording_${new Date().toISOString().replace(/[:.]/g,'-')}.webm`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  };
  // optionally show link in page:
  const d = document.createElement('div');
  d.innerHTML = `<p><small>Recording finished. <button id="dl2">Download</button></small></p>`;
  document.getElementById('content').appendChild(d);
  document.getElementById('dl2').onclick = downloadRecordingBtn.onclick;
}

/* -------------------------
   Snapshot function
   ------------------------- */
function takeSnapshot(){
  if(!mediaStream) return;
  const videoTrack = mediaStream.getVideoTracks()[0];
  if(!videoTrack) return;
  const canvas = document.createElement('canvas');
  const v = preview;
  canvas.width = v.videoWidth || 320;
  canvas.height = v.videoHeight || 240;
  const ctx = canvas.getContext('2d');
  try {
    ctx.drawImage(v, 0, 0, canvas.width, canvas.height);
    const img = new Image();
    img.src = canvas.toDataURL('image/jpeg', 0.8);
    img.title = new Date().toLocaleTimeString();
    const wrapper = document.createElement('div');
    wrapper.appendChild(img);
    wrapper.appendChild(document.createElement('br'));
    document.getElementById('snapshots').prepend(wrapper);
    // optionally store snapshot data to upload to server
  } catch(e) {
    console.warn('Snapshot failed', e);
  }
}

/* -------------------------
   Download recording helper
   ------------------------- */
function downloadRecording(){
  // implemented by createRecordingBlob -> sets downloadRecordingBtn.onclick
  // here we just call the click handler if ready
  if(downloadRecordingBtn.onclick) downloadRecordingBtn.onclick();
}

/* -------------------------
   initialize small defaults
   ------------------------- */
//document.getElementById('startExamBtn').disabled = true;
//document.getElementById('submitBtn').disabled = false;

</script>
</body>
</html>