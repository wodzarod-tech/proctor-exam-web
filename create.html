<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Google Forms Clone ‚Äì UI + Drag & Drop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <style>
    :root{
      --purple:#2e7d32;
      /*--purple:#673ab7;*/
      --bg:#f1f3f4;
      --card:#ffffff;
      --border:#dadce0;
      --text:#202124;
    }

    body{
      margin:0;
      font-family:Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      /* Mobile centering */
      display: flex;
      justify-content: center;
    }

    header{
      background:var(--purple);
      height:8px;
    }

    /* Form header total points */
    .form-header-row{
      display: flex;
      align-items: flex-start;
      gap: 16px;
    }

    /* for mobile */
    @media (max-width: 600px){
      .form-header-row{
        flex-direction: column;
        gap: 8px;
      }

      .total-points{
        margin-left: 0;
        align-self: flex-end;
      }

      .title-input{
        font-size: 24px;
      }
    }

    .total-points strong{
      font-size: 16px;
      font-weight: 500;
      color: #202124;
    }

    .container{
      width: 100%;
      max-width:820px;
      /*margin:24px auto;*/

      /* Mobile padding */
      padding: 16px 12px 120px; /* bottom padding avoids toolbar overlap */
      box-sizing: border-box;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-left: 4px solid transparent;
      border-radius:8px;
      padding:20px;
      margin-bottom:16px;
      position:relative;
    }

    /* for mobile */
    @media (max-width: 600px){
      .card{
        padding: 16px;
        border-radius: 10px;
      }
    }

    .card.active{
      border-left-color: #1a73e8; /* blue active question indicator */
    }
    .title-input{
      font-size:32px;
      border:none;
      outline:none;
      width:100%;
      margin-bottom:8px;
    }

    .desc-input{
      border:none;
      outline:none;
      width:100%;
      color:#5f6368;
    }

    select{
      padding:6px;
      border:1px solid var(--border);
      border-radius:4px;
      margin-bottom:12px;
    }

    .option{
      position: relative;
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }

    /* option multiline: textarea look like input */
    .option .opt-text{
      width: 100%;
      resize: none;
      overflow: hidden;
      line-height: 1.4;
      background: transparent;
      font-family: inherit;
      font-size: 14px;
      border: none;
      outline: none;
    }

    .option input[type=text]{
      flex:1;
      /*border:none;
      border-bottom:1px solid var(--border);*/
      outline:none;
    }

    .q-title{
      font-size:16px;
      width:100%;
      /*border:none;
      border-bottom:1px solid var(--border);*/
      outline:none;
      margin-bottom:12px;
      /* multiline */
      resize: none;
      overflow: hidden;
      line-height: 1.4;
      caret-color: transparent;
    }

    /* Show caret only when question card is active */
    .question.active .q-title,
    .q-title:focus {
      caret-color: auto;
    }

    /* Default: no visible bottom border */
    .q-title,
    .option input[type=text]{
      border: none;
      border-bottom: 1px solid transparent;
    }

    /* Show border ONLY when question card is active */
    .card.active .q-title,
    .card.active .option input[type=text]{
      border-bottom-color: var(--border);
    }

    /* Focus highlight ONLY inside active card */
    .card.active .q-title:focus,
    .card.active .option input[type=text]:focus{
      border-bottom-color: #1a73e8;
    }

    /* Default: hide borders & fade controls */
    .q-type,
    .card .btn-link{
      opacity: 0;
      pointer-events: none;
    }

    /* Active question: show controls */
    .card.active .q-type,
    .card.active .btn-link{
      opacity: 1;
      pointer-events: auto;
    }

    /* Smooth appearance */
    .q-type,
    .card .btn-link{
      transition: opacity .15s ease;
    }

    /* Remove select border when inactive */
    .q-type{
      border-color: transparent;
    }

    /* Show select border only when active */
    .card.active .q-type{
      border-color: var(--border);
    }

    /* Focus highlight */
    .card.active .q-type:focus{
      border-color: #1a73e8;
    }

    /* select points for questions */
    .question-header{
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .q-points{
      margin-left: auto; /* pushes points to the right */
      display: flex;
      align-items: center;
      gap: 4px;
      color: #5f6368;
      font-size: 13px;
    }

    .points-input{
      width: 52px;
      border: none;
      border-bottom: 1px solid transparent;
      text-align: right;
      font-size: 13px;
      color: #202124;
      outline: none;
    }

    .points-input:focus{
      border-bottom-color: #1a73e8;
    }

    .q-points span{
      font-size: 13px;
    }

    /* option drag & drop */
    .opt-drag{
      /* Hidden by default */
      opacity: 0;
      pointer-events: none;
      transition: opacity .15s ease;
      
      position: absolute;
      left: -15px;          /* adjust if needed */
      top: 50%;
      transform: translateY(-50%);

      cursor: grab;
      color: #9aa0a6;
      user-select: none;
      font-size: 18px;
      line-height: 1;
      /*margin-right: 4px;*/
    }

    /* Visible only on active question */
    .card.active .opt-drag{
      opacity: 1;
      pointer-events: auto;
    }

    .opt-icon{
      accent-color: #5f6368; /* Google Forms gray */
    }

    .btn-link{
      background:none;
      border:none;
      color:var(--purple);
      cursor:pointer;
      padding:4px 0;
    }

    .g-tooltip{
      position: relative;
    }

    .g-tooltip::after{
      content: attr(data-tooltip);
      position: absolute;
      bottom: calc(100% + 8px);
      /*bottom: 125%;*/
      left: 50%;
      transform: translateX(-50%);

      background: #3c4043;
      color: #fff;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;

      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity .15s ease;
      z-index: 1000;
    }

    .g-tooltip:hover::after,
    .g-tooltip:focus-visible::after{
      opacity: 1;
    }

    .actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:12px;
    }

    /* Delete button */
    .actions .btn-link{
      font-size: 18px;
      color: #5f6368;
    }

    .actions .btn-link:hover{
      color: #d93025; /* Google red on delete */
    }

    .drag{
      display: flex;
      justify-content: center;
      align-items: center;

      width: 100%;
      height: 24px;

      margin: -8px 0 8px 0;   /* pull it slightly up like GForms */
      cursor: grab;
      user-select: none;

      color: #9aa0a6;
      font-size: 18px;
      line-height: 4;

      pointer-events: auto;
    }

    /* Required toggle */
    .required-toggle{
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #5f6368;
      /* Hide Required toggle by default */
      pointer-events: none;
      /*transition: opacity .15s ease;*/
      visibility: hidden;
    }

    /* Show ONLY when question card is active */
    .card.active .required-toggle{
      pointer-events: auto;
      visibility: visible;
    }

    /* Switch */
    .switch{
      position: relative;
      width: 36px;
      height: 18px;
    }

    .switch input{
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider{
      position: absolute;
      cursor: pointer;
      inset: 0;
      background-color: #dadce0;
      border-radius: 18px;
      transition: 0.2s;
    }

    .slider:before{
      content: "";
      position: absolute;
      height: 14px;
      width: 14px;
      left: 2px;
      top: 2px;
      background-color: white;
      border-radius: 50%;
      transition: 0.2s;
    }

    .switch input:checked + .slider{
      background-color: var(--purple); /* your green */
    }

    .switch input:checked + .slider:before{
      transform: translateX(18px);
    }

    /*
    .add-question{
      width:100%;
      padding:12px;
      font-size:16px;
      border:1px dashed var(--border);
      background:white;
      cursor:pointer;
      border-radius:8px;
    }*/

    pre{
      background:#111;
      color:#0f0;
      padding:12px;
      font-size:12px;
      overflow:auto;
    }

    /* Right toolbar */
    /*
    .gforms-toolbar{
      position: fixed;
      right: 24px;
      top: 30px;

      background: white;
      border: 1px solid #dadce0;
      border-radius: 8px;

      display: flex;
      flex-direction: column;
      gap: 8px;

      padding: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,.2);

      /* hide by default */
      /*opacity: 0;
      pointer-events: none;
      transition: opacity .15s ease;
    }

    .gforms-toolbar button{
      width: 40px;
      height: 40px;

      border: none;
      background: none;
      font-size: 22px;
      cursor: pointer;
      color: #5f6368;

      border-radius: 50%;
    }

    .gforms-toolbar button:hover{
      background: #f1f3f4;
    }
    */

    /* Bottom toolbar */
    .gforms-toolbar.bottom{
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);

      display: flex;
      align-items: center;
      gap: 12px;

      background: white;
      border: 1px solid #dadce0;
      border-bottom: none;

      border-radius: 12px 12px 0 0;
      padding: 8px 12px;

      box-shadow: 0 -2px 6px rgba(0,0,0,.15);

      transition: transform .25s ease;
      z-index: 1000;
    }

    /* Hidden state */
    .gforms-toolbar.bottom.hidden{
      transform: translateX(-50%) translateY(100%);
    }

    .gforms-toolbar.collapsed{
      transform: translateX(-50%) translateY(100%);
    }

    /* Buttons row */
    .toolbar-buttons{
      display: flex;
      gap: 8px;
    }

    /* Toolbar buttons */
    .gforms-toolbar button{
      width: 40px;
      height: 40px;

      border: none;
      background: none;
      font-size: 22px;
      cursor: pointer;
      color: #5f6368;
      border-radius: 50%;
    }

    .gforms-toolbar button:hover{
      background: #f1f3f4;
    }

    /* Handle */
    .toolbar-handle{
      position: absolute;
      top: -28px;
      left: 50%;
      transform: translateX(-50%);

      width: 28px;
      height: 28px;

      border-radius: 50%;
      /*background: white;
      border: 1px solid #dadce0;*/

      display: flex;
      align-items: center;
      justify-content: center;

      font-size: 14px;
      cursor: pointer;
      color: #5f6368;

      /*box-shadow: 0 1px 3px rgba(0,0,0,.2);*/
    }

    /* Section */
    .section-label{
      font-size: 13px;
      color: #5f6368;
      margin-bottom: 8px;
    }

    /* Feedback */
    /* Feedback visibility like Google Forms */
    .feedback{
      position: relative;
      display: flex;
      flex-direction: column;
      /*align-items: flex-start;*/
      gap: 2px;
      margin-top: 8px;
    }

    /* Default: no underline */
    .feedback .q-title{
      border-bottom-color: transparent;
      transition: border-color .15s ease;
    }

    .feedback-ok-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 500;
      color: #188038;
      margin-bottom: 6px;
    }

    .feedback-error-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 500;
      color: #ed0b0b;
      margin-bottom: 6px;
    }

    .feedback-icon {
      font-size: 14px;
      line-height: 1;
    }

    /* Active question: show underline */
    .card.active .feedback .q-title{
      border-bottom-color: var(--border);
    }

    /* Focus highlight */
    .card.active .feedback .q-title:focus{
      border-bottom-color: #1a73e8;
    }

    .feedback-group{
      display: flex;
      flex-direction: column;
    }

    .feedback-group textarea{
      margin-top: 2px;
      padding-left: 2px;
    }

    .feedback-group textarea:placeholder-shown {
      opacity: 0.95;
    }

    /* for mobile */
    @media (max-width: 600px){
      textarea,
      input[type="text"]{
        font-size: 16px; /* prevents iOS zoom */
      }

      .opt-drag{
        left: -10px;
      }
    }

    /* Settings modal */
    .proctor-modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .proctor-modal.hidden{
      display: none;
    }

    .proctor-card{
      background: white;
      width: 520px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
      overflow: hidden;
    }

    .proctor-header{
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1px 20px;
      border-bottom: 1px solid var(--border);
    }

    .settings-tabs{
      display: flex;
      border-bottom: 1px solid var(--border);
    }

    .settings-tabs .tab{
      flex: 1;
      padding: 10px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      color: #5f6368;
    }

    .settings-tabs .tab.active{
      color: var(--purple);
      border-bottom: 2px solid var(--purple);
      font-weight: 500;
    }

    .settings-content{
      padding: 20px;
      padding-top: 8px;
      padding-bottom: 1px;
    }

    .tab-panel{
      display: none;
    }

    .tab-panel.active{
      display: block;
    }

    .toggle-row{
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .toggle-inline{
      display:flex;
      align-items:center;
      gap:6px;
    }

    .toggle-row{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .btn-icon{
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }

    /* Save button */
    .proctor-footer{
      /*margin-top: 20px;*/
      /*padding-top: 8px;*/
      /*border-top: 1px solid #eee;*/
      display: flex;
      justify-content: center;
    }

    .btn-save{
      background: #4f46e5;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 12px 28px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background .2s ease, transform .1s ease;
    }

    .btn-save:hover{
      background: #4338ca;
    }

    .btn-save:active{
      transform: scale(0.97);
    }

    /* Disabled Save button */
    .btn-save:disabled{
      background: #c7c9f5;          /* muted purple */
      color: #ffffff;
      cursor: not-allowed;
      opacity: 0.6;
      transform: none;
      box-shadow: none;
    }

    /* Prevent hover effects when disabled */
    .btn-save:disabled:hover{
      background: #c7c9f5;
    }

    /* Score to pass */
    .score-row{
      display:flex;
      align-items:center;
      margin-left:4px;
    }

    .score-input{
      width:42px;
      text-align:center;
      border:none;
      border-bottom:1px solid transparent;
      text-align:right;
      font-size:13px;
      color:#202124;
      outline:none;
      background:transparent;
    }

    .score-input:focus{
      border-bottom-color:#1a73e8;
    }

    /* keep native steppers */
    .score-input::-webkit-inner-spin-button,
    .score-input::-webkit-outer-spin-button{
      opacity:1;
    }

    /* Timer */
    .timer-row{
      display:flex;
      align-items:center;
      margin-left:4px;
      /*margin-left:auto;*/
    }

    .timer-input{
      width:42px;
      text-align:center;
      border:none;
      border-bottom:1px solid transparent;
      text-align:right;
      font-size:13px;
      color:#202124;
      outline:none;
      background:transparent;
    }

    .timer-input:focus{
      border-bottom-color:#1a73e8;
    }

    /* keep native steppers */
    .timer-input::-webkit-inner-spin-button,
    .timer-input::-webkit-outer-spin-button{
      opacity:1;
    }

    /* Top-right delete button (Google Forms style) */
    .delete-top{
      background: rgb(220, 53, 69);
      color: white;
      border: none;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      box-shadow: rgba(0, 0, 0, 0.15) 0px 2px 4px;
  
      position: absolute;
      top: 12px;
      right: 12px;
      opacity: 0;
      pointer-events: none;
    }

    /* Show only when question is active */
    .card.active .delete-top{
      opacity: 1;
      pointer-events: auto;
    }

    .delete-top:hover{
      color: #5f6368;
    }

  </style>
</head>
<body>

<header></header>

<div class="container">

  <!-- Form header -->
<div class="card form-header">
  <div class="form-header-row">
    <div>
      <input class="title-input" id="formTitle" placeholder="Title" />
      <input class="desc-input" id="formDesc" placeholder="Form description" />
    </div>

    <div class="total-points">
      <span>Total points</span>
      <strong id="totalPoints">0</strong>
    </div>
  </div>
</div>

  <!-- Questions -->
  <div id="questions"></div>

  <!-- <button class="add-question" onclick="addQuestion()">+ Add question</button> -->

  <!-- JSON view -->
  <div style="display:block">
    <h3 >Form JSON</h3>
    <pre id="output"></pre>
  </div>
</div>

<!-- Bottom toolbar -->
<div id="gformsToolbar" class="gforms-toolbar bottom">
  <!-- Handle -->
  <div class="toolbar-handle g-tooltip" id="toolbarHandle" data-tooltip="Close panel" onclick="toggleToolbar()">‚ñº</div>

  <div class="toolbar-buttons">
    <button class="g-tooltip" data-tooltip="Add question" onclick="addQuestion()">+</button>
    <button class="g-tooltip" data-tooltip="Add section" style="display:none;" onclick="addSection()">‚â°</button>
    <button class="g-tooltip" data-tooltip="Import Exam" onclick="importJSON()">üìÇ</button>
    <button class="g-tooltip" data-tooltip="Export Exam" onclick="exportJSON()">üíæ</button>
    <button class="g-tooltip" data-tooltip="Settings" onclick="openProctorConfig()">‚öôÔ∏è</button>
    <button class="g-tooltip" data-tooltip="Preview exam" onclick="previewExam()">üëÅÔ∏è</button>
    <button class="g-tooltip" data-tooltip="Home" onclick="window.location.href='index.html'">üè†</button>
  </div>
</div>

<!-- hidden file input -->
<input
  type="file"
  id="jsonFileInput"
  accept="application/json"
  hidden
/>

<!-- Proctor Modal -->
<div id="proctorModal" class="proctor-modal hidden">
  <div class="proctor-card">

    <div class="proctor-header">
      <h3>Settings</h3>
      <button class="btn-icon" onclick="closeProctorConfig()">‚úï</button>
    </div>

    <!-- Settings Tabs -->
    <div class="settings-tabs">
      <button class="tab active" onclick="switchSettingsTab('general')">General</button>
      <button class="tab" onclick="switchSettingsTab('proctor')">Proctor üõ°Ô∏è</button>
    </div>

    <!-- Tab contents -->
    <div class="settings-content">

      <!-- General Settings -->
      <div class="tab-panel active" id="tab-general">

        <label class="toggle-row"><strong>General:</strong></label>
        <label class="toggle-row" style="display:none;">
          <input type="checkbox" data-proctor="shuffle-questions" />
          <span>Shuffle questions</span>
        </label>

        <label class="toggle-row" style="display:none;">
          <input type="checkbox" data-proctor="shuffle-options" />
          <span>Shuffle options</span>
        </label>

        <label class="toggle-row">
          <input type="checkbox" data-proctor="view-toggle-questions" />
          <span>View toggle questions (One by One/All)</span>
        </label>
        
        <label class="toggle-row">
          <input type="checkbox" data-proctor="view-questions" />
          <span>View questions One by One</span>
        </label>

        <div class="toggle-inline">
          <label class="toggle-row">
            <input type="checkbox" data-proctor="score-min" onchange="toggleScoreMin(this)" />
            <span>Score minimum to pass (%)</span>
          </label>

          <div class="score-row" style="display:none">
              <input
                type="number"
                class="score-input"
                min="0"
                step="1"
                value="0"
              />%
          </div>
        </div>
      </div>
      
      <!-- Proctor Settings -->
      <div class="tab-panel" id="tab-proctor">

        <!-- Timer -->
        <label class="toggle-row"><strong>Timer:</strong></label>

        <div class="toggle-inline">
          <label class="toggle-row">
            <input type="checkbox" data-proctor="timer-enabled" onchange="toggleTimer(this)" />
            <span>Timer Left (hour | minutes)</span>
          </label>

          <div class="timer-row" style="display:none">
            <input
              type="number"0
              class="timer-input"
              min="0"
              max="24"
              step="1"
              value="0"
              oninput="fixHour(this); updateTimerJSON()"
            />h
            <span>:</span>
            <input
              type="number"
              class="timer-input"
              min="0"
              max="59"
              step="1"
              value="0"
              oninput="fixMinutes(this); updateTimerJSON()"
            />min
          </div>
        </div>

        <!-- Camera -->
        <label class="toggle-row"><strong>Camera:</strong></label>
        <label class="toggle-row">
          <input type="checkbox" data-proctor="camera-enabled" />
          <span>Show camera</span>
        </label>

        <label class="toggle-row">
          <input type="checkbox" data-proctor="camera-face" />
          <span>Face Detection: Detect Face absence</span>
        </label>

        <label class="toggle-row">
          <input type="checkbox" data-proctor="camera-eye" />
          <span>Eye-Tracking: Gaze Direction</span>
        </label>

        <!-- Microphone -->
        <label class="toggle-row"><strong>Microphone:</strong></label>

        <label class="toggle-row">
          <input type="checkbox" data-proctor="microphone-enabled" />
          <span>Show microphone</span>
        </label>

        <label class="toggle-row">
          <input type="checkbox" data-proctor="noise-loud" />
          <span>Noise-detection: Detect loud background noise</span>
        </label>

        <!-- Screen -->
        <label class="toggle-row"><strong>Screen:</strong></label>
        <label class="toggle-row">
          <input type="checkbox" data-proctor="screen-tab"/>
          <span>Detect tab switching or minimize</span>
        </label>

        <label class="toggle-row">
          <input type="checkbox" data-proctor="screen-fullscreen"/>
          <span>Detect fullscreen exit</span>
        </label>

        <label class="toggle-row">
          <input type="checkbox" data-proctor="screen-devtools"/>
          <span>Detect DevTools Opening</span>
        </label>

        <label class="toggle-row">
          <input type="checkbox" data-proctor="screen-leave"/>
          <span>Detect leaving fullscreen</span>
        </label>

        <label class="toggle-row">
          <input type="checkbox" data-proctor="screen-keyshortcuts"/>
          <span>Block Keyboard Shortcuts</span>
        </label>

        <label class="toggle-row">
          <input type="checkbox" data-proctor="screen-secondmonitor"/>
          <span>Fake "Second Monitor Detection"</span>
        </label>

      </div>

    </div>

    <div class="proctor-footer">
      <button class="btn-save" onclick="saveProctorSettings()" disabled>üíæ Save</button>
    </div>

  </div>

</div>

<script>

// question must have its own radio group name
let questionIdCounter = 0; // question ID

const questionsEl = document.getElementById('questions');
const outputEl = document.getElementById('output');

/***************************
Header
***************************/
// Add total points calculation
function updateTotalPoints(){
  let total = 0;

  document.querySelectorAll('.points-input').forEach(input => {
    const val = parseFloat(input.value);
    if (!isNaN(val)) total += val;
  });

  document.getElementById('totalPoints').textContent =
    total % 1 === 0 ? total : total.toFixed(2);
}

/***************************
Questions
***************************/
document.addEventListener('input', e => {
  // auto-resize: add question/option multiline
  if(e.target.classList.contains('q-title') ||
    e.target.classList.contains('opt-text')){
    e.target.style.height = 'auto';
    e.target.style.height = e.target.scrollHeight + 'px';
  }

  updateJSON();
});

// Auto-save while editing
// Saves after typing stops
let autosaveTimer;

document.addEventListener('input', () => {
  clearTimeout(autosaveTimer);

  const data = outputEl.textContent;
  if(!data) return;

  autosaveTimer = setTimeout(() => {
    debugger;
    localStorage.setItem('formContent',data);
  }, 500);
});

// Toggleable radios
document.addEventListener('click', e => {
  const radio = e.target;

  if (!radio.classList.contains('opt-icon')) return;

  if (radio.type !== 'radio') return;

  // if it was already checked, uncheck it
  if (radio.dataset.wasChecked === 'true') {
    radio.checked = false;
    radio.dataset.wasChecked = 'false';
  } else {
    // uncheck other radios in same group
    document
      .querySelectorAll(`input[type="radio"][name="${radio.name}"]`)
      .forEach(r => r.dataset.wasChecked = 'false');

    radio.dataset.wasChecked = 'true';
  }

  updateJSON();
});

function addQuestion(){
  const q = document.createElement('div');
  q.className = 'card question';
  q.dataset.qid = 'q_' + (++questionIdCounter); // ID question

  q.innerHTML = `
    <div class="drag">: : :</div>

    <div class="question-header">

      <div class="q-counter" style="
        font-size:13px;
        color:#5f6368;
        margin-right:auto;
      ">
        1 de 1
      </div>

      <button class="btn-link g-tooltip delete-top"
        data-tooltip="Delete question"
        onclick="removeQuestion(this)">
      <i class="fa fa-trash"></i></button>
      
      <div class="q-points">
        <input type="number"
          class="points-input"
          min="0"
          step="0.01"
          placeholder="0"
          oninput="limitDecimals(this); updateJSON()" />
        <span>points</span>
      </div>
    </div>

    <textarea class="q-title" placeholder="Question" rows="1"></textarea>

    <select class="q-type" onchange="updateOptions(this)">
      <option value="radio">‚óâ One choice</option>
      <option value="checkbox">‚òë Multiple choices</option>
    </select>

    <div class="options"></div>

    <div>
      <button class="btn-link" onclick="addOption(this)">Add option</button>
    </div>

    <div class="feedback">

      <div class="feedback-group ok">
        <div class="feedback-ok-label">
          <span class="feedback-icon">‚úî</span>
          <span>Feedback for correct answers:</span>
        </div>
        <textarea class="q-title q-comment-ok" rows="1" placeholder="Feedback"></textarea>
      </div>

      <div class="feedback-group error">
        <div class="feedback-error-label">
          <span class="feedback-icon">‚úñ</span>
          <span>Feedback for incorrect answers:</span>
        </div>
        <textarea class="q-title q-comment-error" rows="1" placeholder="Feedback"></textarea>
      </div>

    </div>

    <div class="actions">
      <!--
      <button class="btn-link g-tooltip"
        data-tooltip="Duplicate"
        onclick="duplicateQuestion(this)">
        üìÑ
      </button>-->

      <div class="required-toggle">
        <span>Required</span>
        <label class="switch">
          <input type="checkbox" class="q-required" onchange="updateJSON()">
          <span class="slider"></span>
        </label>
      </div>
    </div>
  `;

  questionsEl.appendChild(q);
  addOption(q.querySelector('.btn-link'));
  enableOptionDrag(q); // drag & drop per option
  updateJSON();

  updateQuestionCounters();

  // Auto-focus question text:
  // when clicking Add question, then cursor automatically appears in the question text
  setTimeout(() => {
    q.querySelector('.q-title').focus();
  }, 0);
}

function duplicateQuestion(btn){
  const q = btn.closest('.question');
  const clone = q.cloneNode(true);

  // new question ID (important for radio groups)
  clone.dataset.qid = 'q_' + (++questionIdCounter);

  // fix radio group names
  clone.querySelectorAll('.opt-icon[type="radio"]').forEach(radio => {
    radio.name = clone.dataset.qid;
  });

  // remove active styles
  clone.classList.remove('active');

  // insert after original
  q.after(clone);

  // re-enable drag & drop for options
  enableOptionDrag(clone);

  updateJSON();
}

function removeQuestion(btn){
  btn.closest('.question').remove();
  updateJSON();
  updateSectionNumbers();
  updateQuestionCounters();
}

// points: enforce max 2 decimals
function limitDecimals(input){
  const value = input.value;
  if (!value.includes('.')) return;

  const [int, dec] = value.split('.');
  if (dec.length > 2){
    input.value = `${int}.${dec.slice(0,2)}`;
  }
}
 
// show {question-number} de {total-questions}
function updateQuestionCounters() {
  const questions = [...document.querySelectorAll('.question')];
  const total = questions.length;

  questions.forEach((q, index) => {
    let counter = q.querySelector('.q-counter');
    if (!counter) return;

    counter.textContent = `${index + 1} de ${total}`;
  });
}

function addOption(btn){
  const q = btn.closest('.question');
  const type = q.querySelector('.q-type').value;
  const options = q.querySelector('.options');
  const qid = q.dataset.qid; // ID question

  const opt = document.createElement('div');
  opt.className = 'option';

  opt.innerHTML = `
    <div class="opt-drag">‚ãÆ‚ãÆ</div>
    <input class="opt-icon" type="${type}"
    ${type === 'radio' ? `name="${qid}" data-was-checked="false"` : ''} />
    <textarea class="opt-text" rows="1"></textarea>
    <button class="btn-link g-tooltip" data-tooltip="Remove"
      onclick="removeOption(event, this)">‚úï</button>
  `;
    // assign name to radio inputs when adding options

  const optionNumber = getNextOptionNumber(q);
  const textInput = opt.querySelector('.opt-text');
  textInput.placeholder = `Option ${optionNumber}`; // option dynamic placeholder numbering

  options.appendChild(opt);

  enableOptionDrag(opt); // drag & drop per option

  updateJSON();

  // Auto-focus option text:
  // when clicking Add option, then cursor automatically appears in the question text
  setTimeout(() => {
    textInput.focus();
  }, 0);
}

function removeOption(e, btn){
  e.preventDefault();
  e.stopPropagation();

  const option = btn.closest('.option');
  option.remove();
  updateJSON();
}

function updateOptions(select){
  const q = select.closest('.question');
  const type = select.value;
  const qid = q.dataset.qid; // ID question

  q.querySelectorAll('.opt-icon').forEach(icon => {
    icon.type = type;     // radio or checkbox
    icon.checked = false;

    if(type === 'radio'){
      icon.name = qid;
      icon.dataset.wasChecked = 'false'; // toggleable radios
    } else {
      icon.removeAttribute('name');
      delete icon.dataset.wasChecked; // toggleable radios
    }
  });

  updateJSON();
}

// Track option count per question
function getNextOptionNumber(q){
  return q.querySelectorAll('.opt-text').length + 1;
}

// enable drag & drop per options
function enableOptionDrag(q){
  const options = q.querySelector('.options');

  if(!options || options._sortable)
    return;

  // drag starts only from .opt-drag
  options._sortable = new Sortable(options, {
    handle: '.opt-drag',
    animation: 150,
    filter: '.opt-icon, .opt-text, button',
    preventOnFilter: false,
    onEnd: updateJSON
  });
}

// Auto-delete option if text is empty on blur
// An option will be auto-deleted on blur ONLY IF:
//   ‚úî The text is empty (or whitespace)
//   ‚úî There is more than one option in the question
//   ‚ùå It is not the last remaining option
document.addEventListener('blur', e => {
  const input = e.target;

  if (!input.classList.contains('opt-text')) return;

  const option = input.closest('.option');
  const optionsContainer = option.parentElement;

  // Trim text
  const value = input.value.trim();

  // Keep at least one option
  if (value === '' && optionsContainer.children.length > 1) {
    option.remove();
    updateJSON();
  }
}, true); // üëà use capture so blur is detected

// auto-resize textareas when import JSON file
function autoResizeTextarea(el){
  if (!el) return;
  el.style.height = 'auto';
  el.style.height = el.scrollHeight + 'px';
}

/***************************
Preview exam
***************************/
function previewExam() {
  const data = outputEl.textContent;
  if(!data) return;

  localStorage.setItem('formContent', data);

  // open preview in the same tab
  window.location.href = "preview.html";

  // Option 1: open preview in a new tab
  //window.open("preview.html", "_blank");

  // Option 2 (alternative): show preview modal
  // document.getElementById("previewModal").classList.add("open");
}

/***************************
Proctor configuration
***************************/
function openProctorConfig(){
  document.getElementById('proctorModal').classList.remove('hidden');
}

function closeProctorConfig(){
  document.getElementById('proctorModal').classList.add('hidden');
}

function switchSettingsTab(name){
  document.querySelectorAll('.settings-tabs .tab')
    .forEach(t => t.classList.remove('active'));

  document.querySelectorAll('.tab-panel')
    .forEach(p => p.classList.remove('active'));

  document.querySelector(`[onclick="switchSettingsTab('${name}')"]`)
    .classList.add('active');

  document.getElementById(`tab-${name}`)
    .classList.add('active');
}

function saveProctorSettings(){
  updateJSON();

  const data = outputEl.textContent;
  localStorage.setItem('formContent', data);
  
  document.querySelector('.btn-save').disabled = true;

  closeProctorConfig();

  alert("Settings saved successfully");
}

// Score min
function toggleScoreMin(cb){
  const row = cb.closest('.tab-panel').querySelector('.score-row');
  row.style.display = cb.checked ? 'flex' : 'none';
}

// Timer
function toggleTimer(cb){
  const row = cb.closest('.tab-panel').querySelector('.timer-row');
  row.style.display = cb.checked ? 'flex' : 'none';
}

function fixHour(input){
  if (input.value > 23) input.value = 23;
  if (input.value < 0) input.value = 0;
}

function fixMinutes(input){
  if (input.value > 59) input.value = 59;
  if (input.value < 0) input.value = 0;
}

function updateTimerJSON(){
  const panel = document.getElementById('tab-proctor');
  const min = panel.querySelector('.timer-min')?.value || 0;
  const sec = panel.querySelector('.timer-sec')?.value || 0;

  const totalSeconds = (Number(min) * 60) + Number(sec);

  // save where you want (example)
  console.log('Timer (seconds):', totalSeconds);
}

/***************************
Save in JSON for database
***************************/
function updateJSON(){
  const form = {
    title: formTitle.value,
    description: formDesc.value,
    questions: []
  };

  document.querySelectorAll('.question').forEach(q => {

    // points in JSON
    const pointsInput = q.querySelector('.points-input');
    const points = parseFloat(pointsInput?.value) || 0;

    // build JSON
    form.questions.push({
      text: q.querySelector('.q-title').value,
      type: q.querySelector('.q-type').value,
      points: points,
      required: q.querySelector('.q-required')?.checked || false,
      options: [...q.querySelectorAll('.option')].map(opt => {
        const textInput = opt.querySelector('.opt-text');
        const control = opt.querySelector('.opt-icon');

        return {
          text: textInput.value,
          checked: control.checked
        };
      }),
      feedbackOk: q.querySelector('.q-comment-ok')?.value || '',
      feedbackError: q.querySelector('.q-comment-error')?.value || ''
    });
  });

  form.settings = form.settings || getProctorSettings();

  outputEl.textContent = JSON.stringify(form, null, 2);
  //updateTotalPoints();
}

function isChecked(key){
  return document.querySelector(`[data-proctor="${key}"]`)?.checked || false;
}

function getProctorSettings(){

  // Score Min
  const scoreMinEnabled = isChecked('score-min');
  const scoreMinInput = document.querySelector('.score-input');

  // Timer
  const timerEnabled = isChecked('timer-enabled');
  const [hoursInput, minutesInput] = document.querySelectorAll('#tab-proctor .timer-input');

  return {
    general: {
      shuffleQuestions: isChecked('shuffle-questions'),
      shuffleOptions: isChecked('shuffle-options'),
      viewToggleQuestions: isChecked('view-toggle-questions'),
      viewQuestions: isChecked('view-questions'),
      scoreMin: scoreMinEnabled ? Number(scoreMinInput?.value || 0) : 0
    },
    timer: {
      enabled: timerEnabled,
      hours: timerEnabled ? Number(hoursInput?.value || 0) : 0,
      minutes: timerEnabled ? Number(minutesInput?.value || 0) : 0
    },
    camera: {
      enabled: isChecked('camera-enabled'),
      faceAbsence: isChecked('camera-face'),
      eyeTracking: isChecked('camera-eye')
    },
    microphone: {
      enabled: isChecked('microphone-enabled'),
      loudNoise: isChecked('noise-loud')
    },
    screen: {
      tabSwitch: isChecked('screen-tab'),
      fullscreenExit: isChecked('screen-fullscreen'),
      devToolsOpen: isChecked('screen-devtools'),
      leaveFullScreen: isChecked('screen-leave'),
      blockKeyShortcuts: isChecked('screen-keyshortcuts'),
      secondMonitor: isChecked('screen-secondmonitor')
    }
  };
}

// export JSON in a file
function exportJSON(){
  const data = outputEl.textContent;
  if(!data) return;

  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'form.json';
  document.body.appendChild(a);
  a.click();

  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// import JSON from file
function importJSON(){
  document.getElementById('jsonFileInput').click();
}

document.getElementById('jsonFileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(reader.result);
      loadFormFromJSON(data);
    }catch(err){
      alert('Invalid JSON file');
    }
  };
  reader.readAsText(file);

  // reset input so same file can be re-imported
  e.target.value = '';

  // Prevent page from staying at bottom after import
  window.scrollTo({ top: 0, behavior: 'instant' });

  // scroll to the title
  setTimeout(() => {
    const titleInput = document.getElementById('formTitle');

    if (titleInput) {
      // focus cursor
      titleInput.focus();

      // place cursor at end (or start if you prefer)
      titleInput.setSelectionRange(
        titleInput.value.length,
        titleInput.value.length
      );

      // scroll to title smoothly
      titleInput.scrollIntoView({
        behavior: 'smooth',
        block: 'center'
      });
    }
  }, 50);
});

// load JSON into editor
function loadFormFromJSON(data){
  // clear existing
  questionsEl.innerHTML = '';
  questionIdCounter = 0;

  // header
  formTitle.value = data.title || '';
  formDesc.value = data.description || '';

  // questions
  data.questions?.forEach(qData => {
    addQuestion();

    const q = questionsEl.lastElementChild;

    // auto-resize for question
    const qTitle = q.querySelector('.q-title');
    qTitle.value = qData.text || '';
    autoResizeTextarea(qTitle);

    q.querySelector('.q-type').value = qData.type || 'radio';
    q.querySelector('.points-input').value = qData.points ?? 0;
    updateOptions(q.querySelector('.q-type'));

    // remove default option
    q.querySelector('.options').innerHTML = '';

    qData.options?.forEach(opt => {
      addOption(q.querySelector('.btn-link'));
      const lastOpt = q.querySelector('.options').lastElementChild;

      // auto-resize for options
      const optText = lastOpt.querySelector('.opt-text');
      optText.value = opt.text || '';
      autoResizeTextarea(optText);

      lastOpt.querySelector('.opt-icon').checked = !!opt.checked;
    });

    // feedback
    if(qData.feedbackOk){
      // auto-resize for feedback
      const feedbackOk = q.querySelector('.q-comment-ok');
      feedbackOk.value = qData.feedbackOk;
      autoResizeTextarea(feedbackOk);
    }
    if(qData.feedbackError){
      // auto-resize for feedback
      const feedbackError = q.querySelector('.q-comment-error');
      feedbackError.value = qData.feedbackError;
      autoResizeTextarea(feedbackError);
    }

  });

  // Auto-resize ALL on load
  //q.querySelectorAll('textarea').forEach(autoResizeTextarea);

  updateJSON();

  updateQuestionCounters();
}

/***************************
Right toolbar
***************************/
/*
// toolbar appears only when a card is focused
document.addEventListener('click', e => {
  const card = e.target.closest('.card.question');
  const toolbar = document.querySelector('.gforms-toolbar');

  if(card){
    toolbar.style.opacity = '1';
    toolbar.style.pointerEvents = 'auto';
  } else {
    toolbar.style.opacity = '0';
    toolbar.style.pointerEvents = 'none';
  }
});
*/

/***************************
Bottom toolbar
***************************/
function toggleToolbar(){
  const toolbar = document.querySelector('.gforms-toolbar');
  const handle = document.getElementById('toolbarHandle');

  toolbar.classList.toggle('collapsed');

  const isCollapsed = toolbar.classList.contains('collapsed');

  handle.textContent = isCollapsed ? '‚ñ≤' : '‚ñº';
  handle.setAttribute(
    'data-tooltip',
    isCollapsed ? 'Open panel' : 'Close panel'
  );
}

// toolbar: Blue active question indicator
document.addEventListener('click', e => {
  document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));

  const card = e.target.closest('.card');

  if(card)
    card.classList.add('active');
  else
    document.activeElement.blur(); // zero cursor blinking when clicking outside
});

/***************************
Section
***************************/
function addSection(){
  const section = document.createElement('div');
  section.className = 'card';
  section.innerHTML = `
    <div class="section-label"></div>
    <input class="title-input" placeholder="Section title" />
    <input class="desc-input" placeholder="Section description" />
  `;
  questionsEl.appendChild(section);
  updateJSON();
  updateSectionNumbers();
}

// auto numbering
function updateSectionNumbers(){
  const sections = document.querySelectorAll('.section-label');
  sections.forEach((s, i) => {
    s.textContent = `Section ${i + 1} of ${sections.length}`;
  });
}

/***************************
Initialization
***************************/
window.onload = async function() {

  setupSettingsChangeTracking();

  // Restore Auto-save while editing
  // Restore go back button from Preview
  // Read JSON file (awaitable)
  const json = localStorage.getItem("formContent");
  
  if(json) {
    examData = JSON.parse(json);
  
    // Load questions
    loadFormFromJSON(examData);
  
    new Sortable(questionsEl, {
      handle: '.drag',
      animation: 150,
      onEnd: () => {
        updateJSON();
        updateQuestionCounters();
      }
    });

    // Auto-focus title text:
    // when clicking Add question, then cursor automatically appears in the title text
    setTimeout(() => {
      document.getElementById('formTitle')?.focus();
    }, 0);

  } else {
    new Sortable(questionsEl, {
      handle: '.drag',
      animation: 150,
      onEnd: () => {
        updateJSON();
        updateQuestionCounters();
      }
    });

    addQuestion();

    // Auto-focus title text:
    // when clicking Add question, then cursor automatically appears in the title text
    setTimeout(() => {
      document.getElementById('formTitle')?.focus();
    }, 0);
  }
}

// Settings: Enable Save on change
function setupSettingsChangeTracking(){
  const saveBtn = document.querySelector('.btn-save');
  if(!saveBtn) return;

  // All settings inputs
  const inputs = document.querySelectorAll(
    '#proctorModal [data-proctor], #proctorModal .timer-input'
  );

  inputs.forEach(input => {
    input.addEventListener('change', () => {
      saveBtn.disabled = false;
    });

    // for number inputs (MM:ss)
    input.addEventListener('input', () => {
      saveBtn.disabled = false;
    });
  });
}

</script>

</body>
</html>